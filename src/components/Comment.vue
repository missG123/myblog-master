<template>
    <div class="comment_main">
        <div class="comment_write">
            <div class="write_title">
                <span>
                    <svg t="1683967759282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="6029" width="24" height="24">
                        <path
                            d="M113.834667 291.84v449.194667a29.013333 29.013333 0 0 0 28.842666 29.013333h252.928v90.453333l160.597334-90.453333h252.928a29.013333 29.013333 0 0 0 29.013333-29.013333V291.84a29.013333 29.013333 0 0 0-29.013333-29.013333h-665.6a29.013333 29.013333 0 0 0-29.696 29.013333z"
                            fill="#FFDEAD" p-id="6030"></path>
                        <path
                            d="M809.130667 262.826667h-665.6a29.013333 29.013333 0 0 0-28.842667 29.013333v40.106667a29.013333 29.013333 0 0 1 28.842667-29.013334h665.6a29.013333 29.013333 0 0 1 29.013333 29.013334V291.84a29.013333 29.013333 0 0 0-29.013333-29.013333z"
                            fill="#FFF3DB" p-id="6031"></path>
                        <path
                            d="M556.202667 770.048h252.928a29.013333 29.013333 0 0 0 29.013333-29.013333V362.837333s-59.733333 392.533333-724.309333 314.709334v63.488a29.013333 29.013333 0 0 0 28.842666 29.013333h253.098667v90.453333z"
                            fill="#F2C182" p-id="6032"></path>
                        <path
                            d="M619.008 632.32l101.888-35.157333-131.754667-76.117334 29.866667 111.274667zM891.904 148.992a61.44 61.44 0 0 0-84.138667 22.528l-19.968 34.133333 106.666667 61.610667 19.968-34.133333a61.781333 61.781333 0 0 0-22.528-84.138667z"
                            fill="#69BAF9" p-id="6033"></path>
                        <path d="M775.338667 198.775467l131.669333 76.032-186.026667 322.218666-131.6864-76.032z"
                            fill="#F7FBFF" p-id="6034"></path>
                        <path
                            d="M775.168 198.826667l-5.290667 9.216 59.221334 34.133333a34.133333 34.133333 0 0 1 12.458666 46.592l-139.946666 242.346667a34.133333 34.133333 0 0 1-46.762667 12.629333l-59.050667-34.133333-6.656 11.434666 88.746667 51.2L720.896 597.333333l186.026667-322.56z"
                            fill="#D8E3F0" p-id="6035"></path>
                        <path
                            d="M616.448 622.592l2.56 9.728 101.888-35.157333-44.885333-25.941334-59.562667 51.370667zM891.904 148.992c-1.024 0-2.218667-0.853333-3.242667-1.536A61.610667 61.610667 0 0 1 887.466667 204.8l-19.968 34.133333-73.728-42.496-5.12 8.704 106.666666 61.610667 19.968-34.133333a61.781333 61.781333 0 0 0-23.381333-83.626667z"
                            fill="#599ED4" p-id="6036"></path>
                        <path
                            d="M265.898667 417.621333H494.933333a17.066667 17.066667 0 1 0 0-34.133333H265.898667a17.066667 17.066667 0 1 0 0 34.133333zM265.898667 533.504H494.933333a17.066667 17.066667 0 0 0 0-34.133333H265.898667a17.066667 17.066667 0 0 0 0 34.133333z"
                            fill="#3D3D63" p-id="6037"></path>
                        <path
                            d="M959.488 354.645333a99.84 99.84 0 0 0-23.722667-127.488 78.677333 78.677333 0 0 0-142.848-64.170666l-11.605333 20.138666a17.066667 17.066667 0 0 0-20.821333 7.168l-32.085334 55.466667H142.677333a46.250667 46.250667 0 0 0-45.909333 46.08v449.194667a46.08 46.08 0 0 0 45.909333 46.08h236.032v73.386666a17.066667 17.066667 0 0 0 8.362667 14.848 17.066667 17.066667 0 0 0 8.704 2.218667 17.066667 17.066667 0 0 0 8.362667-2.218667l156.672-88.234666h248.32a46.08 46.08 0 0 0 46.08-46.08V398.677333L921.6 283.306667a17.066667 17.066667 0 0 0-4.266667-21.504l1.877334-3.413334a65.365333 65.365333 0 0 1 10.410666 79.189334l-53.077333 91.989333a56.832 56.832 0 0 0 20.821333 77.653333 17.066667 17.066667 0 0 0 24.234667-6.314666 17.066667 17.066667 0 0 0-6.997333-23.04 23.04 23.04 0 0 1-8.362667-31.061334z m-138.410667 386.389334a11.946667 11.946667 0 0 1-11.946666 11.946666H556.202667a17.066667 17.066667 0 0 0-8.362667 2.218667l-134.997333 76.117333v-61.269333a17.066667 17.066667 0 0 0-17.066667-17.066667H142.677333a11.946667 11.946667 0 0 1-11.776-11.946666V291.84a11.946667 11.946667 0 0 1 11.776-11.946667h565.930667L574.464 512a17.066667 17.066667 0 0 0-1.706667 12.970667L597.333333 615.253333H265.898667a17.066667 17.066667 0 1 0 0 34.133334h352.938666a17.066667 17.066667 0 0 0 5.802667 0l102.4-35.328a17.066667 17.066667 0 0 0 9.216-7.509334l85.333333-147.968z m-204.8-184.661334l63.829334 36.864-49.322667 17.066667z m206.848-170.666666v1.365333l-108.373333 186.709333-102.4-59.050666L781.482667 221.866667l102.4 59.050666z m76.458667-161.28L887.466667 244.224l-76.970667-44.373333 11.264-19.797334a44.544 44.544 0 1 1 77.141333 44.544z"
                            fill="#3D3D63" p-id="6038"></path>
                    </svg></span>留言
            </div>
            <CommentWrite @addComment="addComment"></CommentWrite>
        </div>
        <div class="comment_show">
            <div class="show_title">
                <span class="s_title1">Comments|</span>
                <span class="s_title2">{{ commentList.length }}条留言</span>
            </div>
            <div class="show_main">
                <div class="show_item" v-for="(item, index) in commentList" :key="index">
                    <div class="show_img"> <el-avatar shape="square" :size="50" :src="getImgUrl(item.commentorAvatar)" />
                    </div>
                    <div class="show_info">
                        <div class="info_top">
                            <div class="info_top_left">
                                <span class="comment_name">{{ item.commentorName }}</span>
                                <span class="comment_role" v-show="item.commentorNumber == '12345'">博主</span>
                                <span class="comment_time">{{ item.commentTime }}}</span>
                            </div>
                            <div class="info_top_right" @click="goReply(item.commentId!, item.commentorName, 'first')">
                                <span>{{
                                    item.replayList.length
                                }}回复</span>
                            </div>
                        </div>
                        <div class="info_content">
                            <div class="info_word">
                                {{ item.commentText }}
                            </div>
                        </div>
                        <div class="info_reply" v-if="item.replayList.length > 0">
                            <div class="show_item" v-for="(replyItem, index) in item.replayList" :key="index">
                                <div class="show_img"> <el-avatar shape="square" :size="35"
                                        :src="getImgUrl(replyItem.sendImg)" />
                                </div>
                                <div class="show_info">
                                    <div class="info_top">
                                        <div class="info_top_left">
                                            <span class="comment_name_small comment_name">{{ replyItem.sendName }}</span>
                                            <span class="comment_role" v-if="replyItem.sendNumber == '12345'">博主</span>
                                            <span class="comment_time">{{ replyItem.sendTime }}</span>
                                        </div>
                                        <div class="info_top_right"
                                            @click="goReply(item.commentId!, replyItem.sendName, 'second')"><span>回复</span>
                                        </div>
                                    </div>
                                    <div class="info_content">
                                        <div class="info_word">
                                            <span class="to_sign" v-if="replyItem.replyRank == 'second'">@{{
                                                replyItem.sendTo
                                            }}:</span>
                                            {{ replyItem.replyText }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <el-dialog v-model="dialogVisible" title="留言" width="30%" center class="comment_write">
            <CommentWrite @addComment="addReply"></CommentWrite>
        </el-dialog>
    </div>
</template>
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ElMessage } from 'element-plus';
import { reqAddComment, reqGetComment, reqaddReply } from '@/api/comment';
import CommentWrite from './CommentWrite.vue'
import { useUser } from '@/store/user'
const store = useUser()
let dialogVisible = ref(false);
const commentList = ref<Array<CommentContent>>([])
const props = defineProps({
    blogId: {
        type: String,
        default: () => ''
    }
})
const currentReplyTo = ref('');
const currentReplyId = ref('');
const currentRank = ref('');




onMounted(async () => {
    let res = await reqGetComment({ commentblogId: props.blogId })
    if ((res as any).code == 200) {
        commentList.value = res.data
    }
})

const getImgUrl = (imgUrl: string) => {
    return new URL(`../assets/image/${imgUrl}`, import.meta.url).href;
}

const addComment = async (commentText: string, commentTime: string) => {
    let commentinfo = {
        commentTime: commentTime,
        commentText: commentText,
        replayList: [],
        commentblogId: props.blogId,
        commentorNumber: store.userInfo.number,
        commentorName: store.userInfo.name,
        commentorAvatar: store.userInfo.imgUrl,
    }
    let res = await reqAddComment(commentinfo)
    if ((res as any).code == 200) {
        ElMessage({
            type: 'success',
            message: '评论成功'
        })
        commentList.value.push(commentinfo);
    } else {
        ElMessage({
            type: 'warning',
            message: '评论失败'
        })
    }
}
const addReply = async (replyText: string, replyTime: string) => {
    let replyinfo = {
        sendName: store.userInfo.name,
        sendNumber: store.userInfo.number,
        sendImg: store.userInfo.imgUrl,
        replyCommentId: currentReplyId.value,
        sendTime: replyTime,
        sendTo: currentReplyTo.value,
        replyText: replyText,
        replyRank: currentRank.value
    }
    let res = await reqaddReply(replyinfo)

    if ((res as any).code == 200) {
        dialogVisible.value = false
        commentList.value.forEach(item => {
            console.log(item.commentId, currentReplyId)
            if (item.commentId == currentReplyId.value) {
                item.replayList.push(replyinfo)
                return;
            }
        })
    }

}

const goReply = (commentId: string, commentTo: string, rank: string) => {
    console.log(rank)
    dialogVisible.value = true
    currentReplyId.value = commentId;
    currentReplyTo.value = commentTo;
    currentRank.value = rank
}
</script>
<style lang="less" scoped>
.comment_main {
    width: 60%;
    min-height: 600px;
    margin: 0 auto;
    padding: 30px 20px;
    box-sizing: border-box;

    .comment_write {
        margin-top: 20px;

        .write_title {
            text-align: left;
            font-size: 20px;
            font-weight: 700;
            color: rgb(248, 157, 46);

            .icon {
                vertical-align: sub;
            }
        }

        /*     .write_main {
            margin-top: 10px;

            .write_body {
                width: 100%;
                min-height: 180px;
                padding: 10px;
                box-sizing: border-box;
                border: 1px solid rgb(201, 199, 199);
                outline: none;
                resize: none;
                background: url(@/assets/image/letter.png) no-repeat;
                background-position: 100% 100%;
                background-size: contain;

                &:focus {
                    border: 1px solid rgb(248, 157, 46);

                }
            }

            .send_tools {
                display: flex;
                justify-content: space-between;
                margin-top: 10px;

                .tools_icon {
                    span {
                        margin-right: 5px;
                    }

                }

                .submit {
                    width: 66px;
                    height: 33px;
                    line-height: 33px;
                    border-radius: 5px;
                    background-color: rgb(139, 218, 255);
                    text-align: center;

                    &:hover {
                        background-color: rgb(235, 185, 124);

                    }
                }
            }
        } */
    }

    .comment_show {
        margin-top: 40px;

        .show_title {
            text-align: left;

            .s_title1 {
                font-size: 18px;
            }
        }

        .show_main {
            margin-top: 15px;

            .show_item {
                display: flex;

                .show_info {
                    flex: 1;
                    margin-left: 10px;

                    .info_top {
                        display: flex;
                        justify-content: space-between;

                        .info_top_left {
                            span {
                                vertical-align: baseline;
                            }

                            .comment_name {
                                font-size: 18px;
                                margin-right: 10px;
                                color: pink;
                                font-weight: 600;
                            }

                            .comment_name_small {
                                font-size: 15px;
                            }

                            .comment_role {
                                margin: 0px 5px;
                                border: 1px solid skyblue;
                                color: skyblue;
                                border-radius: 5px;
                                font-size: 12px;
                                padding: 2px 4px;
                            }

                            .comment_time {
                                font-size: 12px;
                                color: rgb(144, 144, 144);
                            }
                        }

                        .info_top_right {
                            span {
                                border-radius: 2px;
                                background-color: pink;
                                padding: 4px 5px;
                                font-size: 12px;
                            }
                        }
                    }

                    .info_content {
                        text-align: left;
                        margin: 10px 0px 25px;
                        background-color: rgb(224, 246, 255);
                        border-radius: 10px;
                        padding: 15px;
                        font-size: 14px;
                        word-break: break-all;

                        .info_word {
                            word-break: break-all;

                            .to_sign {
                                font-weight: 700;
                                color: rgb(243, 121, 8);
                            }
                        }
                    }


                }
            }
        }
    }
}
</style>
